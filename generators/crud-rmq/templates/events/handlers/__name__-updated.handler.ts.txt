import { IEventHandler, EventsHandler } from '@nestjs/cqrs';
import {
  nestWinstonUtilities,
  WinstonLogger,
} from '@nestjs-toolkit/winston-logger';
import { <%= namePascal %>UpdatedEvent } from '../impl';

// TODO refatorar para registrar enviar para logstash + kibana
@EventsHandler(<%= namePascal %>UpdatedEvent)
export class <%= namePascal %>UpdatedHandler implements IEventHandler<<%= namePascal %>UpdatedEvent> {
  constructor(private readonly logger: WinstonLogger) {}

  handle({ model, old, dto, context }: <%= namePascal %>UpdatedEvent) {
    const { req, user } = context;
    const causer = {
      collection: 'user_keycloak',
      username: user.username,
      _id: user.sub,
    };

    const detailedDiff = nestWinstonUtilities.diff.detailed(
      old,
      model.toJSON(),
    );

    this.logger
      .activity()
      .tags('<%= namePlural %>')
      .action('<%= namePlural %>:update')
      .requestRpc(req)
      .causedBy(causer)
      .performedOn(model, '<%= namePlural %>')
      .namespaceById('*', 'manager')
      .withProperty('dto', dto)
      .withProperty('diff', detailedDiff)
      .withProperty('model', model.toJSON())
      .contextIn(<%= namePascal %>UpdatedHandler.name)
      .log('cen√°rio atualizado: :subject.name');
  }
}
