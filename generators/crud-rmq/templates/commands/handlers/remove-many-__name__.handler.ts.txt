import { Logger } from '@nestjs/common';
import { CommandHandler, EventBus, ICommandHandler } from '@nestjs/cqrs';
import clc from 'cli-color';
import { ContextType } from '@core/types';
import { <%= namePluralPascal %>Repository } from '../../<%= namePlural %>.repository';
import { <%= namePascal %> } from '../../schemas';
import { <%= namePascal %>RemovedEvent } from '../../events/impl';
import { <%= namePascal %>FilterDto } from '../../dto';
import { RemoveMany<%= namePascal %>Command } from '../impl';

type Response = { nModified: number; results: <%= namePascal %>[] };

@CommandHandler(RemoveMany<%= namePascal %>Command)
export class RemoveMany<%= namePascal %>Handler
  implements ICommandHandler<RemoveMany<%= namePascal %>Command> {
  private logger = new Logger(RemoveMany<%= namePascal %>Handler.name);

  constructor(
    private readonly eventBus: EventBus,
    private readonly repository: <%= namePluralPascal %>Repository,
  ) {}

  async execute({
    filter,
    context,
  }: RemoveMany<%= namePascal %>Command): Promise<Response> {
    const models = await this.repository.findByFilters(filter);

    const promises = models.map((model, index) => {
      this.logger.debug(
        clc.redBright(
          `Init remove <%= nameCamel %> ${index + 1}/${models.length}: ${model.name}`,
        ),
      );

      return this.remove(model, filter, context);
    });

    const results = await Promise.all(promises);
    const modifiers = results.filter((model) => !!model);

    return {
      results: modifiers,
      nModified: modifiers.length,
    };
  }

  private async remove(
    model: <%= namePascal %>,
    filter: <%= namePascal %>FilterDto,
    context: ContextType,
  ): Promise<<%= namePascal %> | null> {
    try {
      await model.remove();
    } catch (e) {
      this.logger.error(e);
      return null;
    }

    this.eventBus.publish(new <%= namePascal %>RemovedEvent(model, filter, context));

    return model;
  }
}
